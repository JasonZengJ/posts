title: JAVA JNI 入门Demo
date: 2015-01-21 00:29:04
tags: Java
---

**引言：**因为一个小师弟在弄opengl，需要构建一套统一的接口，同时给iOS和android两个app使用，苦于没有翻墙软件，使用不靠谱的X度搜出来的东西实在难以恭维，作为技术人员，还是使用google靠谱，经过多方搜索，然后写demo测试，终于跑通了，于是记录下来，以便以后查阅。

参考自：

[linux/Ubuntu 下使用 java 调用 so 动态链接库详细步骤](http://blog.csdn.net/hongquan1991/article/details/12426615)

[Android 开发 之 JNI入门 - NDK从入门到精通](http://blog.csdn.net/shulianghan/article/details/18964835)

###编写java代码JNITest.java

```
public class JNITest {
	  // 声明 so 库中的方法  
    public native static String sayHi(String name);  
  
    // 载入 so 动态链接库  
    static {  
        System.load("/Users/Jason/Documents/Bailm/qf/test.cpp/test.so");  
    }  
  
    // java 类入口函数  
    public static void main(String[] args) {  
        System.out.println(sayHi("Got!"));  
    }  


```

###编译java文件

这里需要做两步

* 1、步是把JNITest.java编译成JNITest.class

```
javac JNITest.java
```
* 2、把JNITest.class编译成JNITest.h文件

```
javah JNITest.h
```

为什么要编译成JNITest.h文件呢？查看编译后的代码：

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class JNITest */

#ifndef _Included_JNITest
#define _Included_JNITest
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     JNITest
 * Method:    sayHi
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_JNITest_sayHi
  (JNIEnv *, jclass, jstring);

#ifdef __cplusplus
}
#endif
#endif

```
发现其实这个JNITest.h文件相当于介于JNITest.class 与 test.c的一座中间桥梁，在JNITest.class 与 test.c之间定义接口规范以便JNITest.class调用test.c中的函数。


###编写java代码调用的c文件代码 test.c

```
   #include "stdio.h"  
   #include "JNITest.h"  
     
   JNIEXPORT jstring JNICALL Java_JNITest_sayHi(JNIEnv *env, jclass jc, jstring name)  
   {  
       return name;  
   }  
      
```

###编译c文件

####test.c



系统环境为Mac os 或 Linux

```

gcc -fPIC -D_REENTRANT -I/Library/Java/JavaVirtualMachines/jdk1.7.0_21.jdk/Contents/Home/include -I/Library/Java/JavaVirtualMachines/jdk1.7.0_21.jdk/Contents/Home/include/darwin -c test.c /* 若无意外，则会生成test.o文件*/


gcc test.c -o test.so -shared

```
其中：

* -I/Library/Java/JavaVirtualMachines/jdk1.7.0_21.jdk/Contents/Home/include 与 -I/Library/Java/JavaVirtualMachines/jdk1.7.0_21.jdk/Contents/Home/include/darwin是包含jni变异所要用到的库文件，jni.h , jni_md.h等等,Linux类似.


###C语言方法声明格式 

```
JNIEXPORT jstring JNICALL Java_JNITest_sayHi(JNIEnv *env, jclass jc, jstring name) 
```
jstring是Java语言中的String类型,方法名格式为Java\_完整包名类名\_方法名();

具体可参考javah生成的.h文件

###坑点：

* 若出现java.lang.UnsatisfiedLinkError: Can't load library，说明加载.so文件的路径不对

```
1、System.load("/home/hongquan/main.so");// 这种方式需要提供 so 文件所在的绝对路径
2、System.loadLibrary("main");// 传入 so 文件的文件名就可以了，不需要后缀,不过这种方式需要把生成的 so 动态链接库复制到 java 的 lib 加载路径中，即LD_LIBRARY_PATH参数对应的目录，可在etc/profile中修改或添加路径。
```

* 若出现**java.lang.UnsatisfiedLinkError:JNITest.sayHi(Ljava/lang/String;)Ljava/lang/String**，则说明c文件的函数没有按规范写。





